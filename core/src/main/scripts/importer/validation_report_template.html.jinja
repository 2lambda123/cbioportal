<!DOCTYPE html>
<html lang="en">
<!--
  Copyright (c) 2016 The Hyve B.V.
  This code is licensed under the GNU Affero General Public License as
  published by the Free Software Foundation, version 3,
  or (at your option) any later version.
-->

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="http://code.jquery.com/jquery-1.12.1.min.js"></script>
  <script>
  </script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <![endif]-->
  <style type="text/css">
  </style>
  <title>cBioPortal validation report: study in '{{ study_dir }}'</title>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>cBioPortal validation report</h1>
      <h4>Study directory:<br />{{ study_dir }}</h4>
      <h4>For details, please see <a href='https://github.com/cbioportal/cbioportal/wiki/File%20Formats'>the documentation on file formats supported by cBioPortal</a></h4>
    </div>

    <div class="panel panel-default">
      <div class="panel-heading">
        <h4 class="panel-title">Legend</h4>
      </div>
      <div class="panel-body">
        <p>
	  Click on a filename below to see a table of messages about the data
	  in the file. The colors in the tables have the following meanings:
        </p>
        <table>
          <tbody>
            <tr class="red"><td><strong>Error:</strong> cBioPortal will not know how to load this, please revise or remove</td></tr>
            <tr class="yellow"><td><strong>Warning:</strong> possible cause of confusion, please check whether this is intended</td></tr>
            <tr class="blue"><td><strong>Info:</strong> this looks good, no action required (filename header will be green)</td></tr>
            <tr class="grey"><td><strong>Verbose output:</strong> details on the progress of the validation script</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="jumbotron">
      <!--  alert alert-danger, alert-success or alert-warning -->
      <div class="alert {% if max_level in ['ERROR','CRITICAL'] %}alert-danger{% elif max_level == 'WARNING' %}alert-warning{% else %}alert-success{% endif %}">
        Validation status:
        <strong>
        {% if max_level in ['ERROR','CRITICAL'] %}
          Failed
        {% elif max_level == 'WARNING' %}
          Please check
        {% else %}
          Success
        {% endif %}
        </strong>
      </div>

      <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
      {% macro generate_group_html(filename, file_record_list) %}
        {% set file_level_list = file_record_list|map(attribute='levelname')|list %}
        {% if 'ERROR' in file_level_list or 'CRITICAL' in file_level_list %}
          {% set file_level = 'danger' %}
        {% elif 'WARNING' in file_level_list %}
          {% set file_level = 'warning' %}
        {# I can't think of a way to check if any values are not INFO right now #}
        {% elif 'INFO' in file_level_list %}
          {% set file_level = 'success' %}
        {% else %}
          {% set file_level = 'info' %}
        {% endif %}
        <div class="panel panel-{{ file_level }}">
          <div class="panel-heading" role="tab">
            <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
              <h4 class="panel-title">{{ filename|e }}</h4>
              <span class="label label-{{ file_level }}" style="position: absolute; right=2.2em">{{ file_level_list|length }}</span>
            </a>
          </div>
          <div class="panel-collapse collapse in" role="tabpanel" {{ {aria-controls: 'heading-%s'|format(filename)}|xmlattr }}>
            <table style="width:100%">
              <tr>
                <th>Line Number</th>
                <th>Column Number</th>
                <th>Message</th>
                <th>Value Encountered</th>
              </tr>
              {% for record in file_record_list %}
              {% if record.levelname  == 'ERROR' or record.levelname == 'CRITICAL' %}
                {% set record_level = 'danger' %}
              {% elif record.levelname == 'WARNING' %}
                {% set record_class = 'warning' %}
              {% elif record.levelname == 'INFO' %}
                {% set record_class = 'success' %}
              {% else %}
                {% set record_class = 'info' %}
              {% endif %}
              <tr class="{{ record_class }}">
                {% macro format_aggregated(record, attr_name) %}
                    {% if record[attr_name + '_list'] is defined -%}
                      {% if (record['show_all_values'] is not defined or record['show_all_values'] == False) and (record[attr_name + '_list']|length) > 3 -%}
                              {{ (record[attr_name + '_list'][:3]|join(', ') +
                                  ', (' +
                                  record[attr_name + '_list'][3:]|length|string +
                                  ' more)')|e }}
                          {%- else -%}
                                  {{ (record[attr_name + '_list']|join(', '))|e }}
                          {%- endif %}	          
                    {%- elif record[attr_name] is defined -%}
                      {{ record[attr_name]|e }}
                    {%- else -%}
                      &ndash;
                    {%- endif %}
                {% endmacro %}
                <td>{{ format_aggregated(record, 'line_number') }}</td>
                {% if record['column_name_list'] is defined %}
                <td>{{ format_aggregated(record, 'column_number') }} <br/>Column names: {{ format_aggregated(record, 'column_name') }}</td>
                {% else %}
                <td>{{ format_aggregated(record, 'column_number') }}</td>
                {% endif %}
                <td>{{ record.getMessage()|e }}</td>
                <td>{{ format_aggregated(record, 'cause') }}</td>
              </tr>
              {% endfor %}
            </table>
          </div>
        </div>

      {% endmacro %}
      {% set fileless_record_list = record_list|selectattr('filename_', 'undefined')|list -%}
      {{ generate_group_html('General', fileless_record_list) }}
      {% set filerelated_record_list = record_list|selectattr('filename_', 'defined') %}
      {% for file_record_group in filerelated_record_list|groupby('filename_') -%}
        {{ generate_group_html(
             file_record_group.grouper.strip()|os.path.relpath(study_dir),
             file_record_group.list) }}
      {%- endfor %}

      </div>
    </div>
  </div>
</body>
</html>
